---
# file: roles/controller/tasks/main.yml


- name: Install supporting programs
  apt:
    update_cache: no
    name: "{{ packages }}"
    state: present
  register: support_progs
  become: true
  become_user: root
  become_method: sudo
  vars:
    packages:
    - owhttpd
    - lsof
    - hostapd
    - dnsmasq


# Default 1-wire port;
#    pin 7, gpio 4 and additional ports
# Additional Original Scorpio Climate systems ports:
#    pin 32, gpio 12
#    pin 31, gpio 6
# Additional OpenHab based Scorpio Climate systems:
#    pin 11, gpio 17
#    pin 13, gpio 27 (OpenHab systems)
# Latest update:
#    switched to USB/Serial-port-based 1-wire controller
- name: Ensure presence of 1-wire config-lines in /boot/config.txt
  lineinfile:
    path: /boot/config.txt
    line: '{{ item }}'
  with_items:
    - 'dtoverlay=w1-gpio,gpiopin=4'
#    - 'dtoverlay=w1-gpio,gpiopin=6'
#    - 'dtoverlay=w1-gpio,gpiopin=12'
    - 'dtoverlay=w1-gpio,gpiopin=17'
    - 'dtoverlay=w1-gpio,gpiopin=27'
  register: boot_config
  become: true
  become_user: root
  become_method: sudo
  when: false


- name: Ensure presence of 1-wire driver in owfs.conf
  lineinfile:
    path: /etc/owfs.conf
    line: '{{ item }}'
  with_items:
    #- 'server: w1'
    - 'server: device = /dev/ttyUSB0'
  register: owfs_config
  become: true
  become_user: root
  become_method: sudo


- name: Install required Openhab add-ons
  command: openhab-cli console -p habopen -b
  args:
    stdin: |
      feature:install openhab-binding-onewire
      feature:install openhab-binding-ntp
    stdin_add_newline: yes


- name: Copy configuration data
  copy:
    src: "../../../../openhab{{ item.path }}/{{ item.filename }}"
    dest: '{{ item.path }}'
    owner: root
    mode: u=rw,g=r,o=r
  with_items:
    - { path: '/etc',                      filename: 'dhcpcd.conf'}
    - { path: '/etc',                      filename: 'dnsmasq.conf'}
    - { path: '/etc/hostapd',              filename: 'hostapd.conf'}
    - { path: '/etc/openhab2/items',       filename: 'default.items' }
    - { path: '/etc/openhab2/sitemaps',    filename: 'default.sitemap' }
    - { path: '/etc/openhab2/things',      filename: 'default.things' }
    - { path: '/etc/openhab2/rules',       filename: 'default.rules' }
    - { path: '/etc/openhab2/rules',       filename: 'circulation.rules' }
    - { path: '/etc/openhab2/rules',       filename: 'followValves.rules' }
    - { path: '/etc/openhab2/rules',       filename: 'powerSaving.rules' }
    - { path: '/etc/openhab2/rules',       filename: 'temperatures.rules' }
    - { path: '/etc/openhab2/rules',       filename: 'stabilitytracking.rules' }
    - { path: '/etc/openhab2/persistence', filename: 'default.persistence' }
    - { path: '/etc/openhab2/transform',   filename: 'weekday.map' }
  become: true
  become_user: root
  become_method: sudo


- name: Copy support programs
  copy:
    src: "../../../../openhab{{ item.path }}/{{ item.filename }}"
    dest: '{{ item.path }}'
    owner: root
    mode: u=rwx,g=rx,o=rx
  with_items:
    - { path: '/usr/bin',    filename: 'scorpio_owserver_to_1wfs' }
    - { path: '/usr/bin',    filename: 'scorpio_1w_scan' }
  become: true
  become_user: root
  become_method: sudo


- name: Stop openHab
  service:
    name: openhab2
    enabled: true
    state: stopped
  register: stop_status
  become: true
  become_user: root
  become_method: sudo
  when: support_progs.changed or boot_config.changed or owfs_config.changed


- name: Clear openHab cache
  command: /usr/bin/openhab-cli clean-cache
  become: true
  become_user: root
  become_method: sudo
  when: stop_status.changed


- name: Reboot the openhab server
  reboot:
  become: true
  become_user: root
  become_method: sudo
  when: support_progs.changed or boot_config.changed or owfs_config.changed


- name: Restart openHab and any other services if needed
  service:
    name: '{{ item }}'
    enabled: true
    state: started
    masked: no
  become: true
  become_user: root
  become_method: sudo
  with_items:
    - openhab2
    - hostapd
    - dnsmasq
